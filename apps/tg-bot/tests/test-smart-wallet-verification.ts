import "dotenv/config";
import { verifyAndLinkAccount } from "../src/services/verification.js";

async function testSmartWalletVerification() {
  console.log("üß™ Testing Smart Wallet Verification");
  console.log("===================================\n");

  // Sample data that would come from the actual verification
  const testData = {
    // This should be the actual wallet address from your test (properly checksummed)
    address: "0x4F4DDe38Da9F8ABBb96C48Ca520b992D4BAdC3D6" as const, // Properly checksummed address
    signature: "0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000001700000000000000000000000000000000000000000000000000000000000000010687e32d4db23d49f49c4efa820c7671957b81cd368b7b1ae7dffc0ff8ea1a997a6a39142d1e4d57aa75cbd7a2b698b67162c77a7cc51c4c3caecda1fcb8924600000000000000000000000000000000000000000000000000000000000000257db01d36896b5474aea489efbe45b1ff1da82a4ce0373c50b3d3cdb6d29510b41d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bb7b2274797065223a22776562617574686e2e676574222c226368616c6c656e6765223a22717470546b35723936596b346e556535457161634738375450756b727266754f75537432396c5f556e654d222c226f726967696e223a2268747470733a2f2f726973652d77616c6c65742d746573746e65742e76657263656c2e617070222c2263726f73734f726967696e223a747275652c22746f704f726967696e223a2268747470733a2f2f6c6f63616c686f73743a33303030227d00000000002ff885fbf40abacad6e1fdb7ae2654ac6cf00b1a82f431a11513ae458238e978000000000000000000000000000000000000000000000000000000000000aa39db0000000000000000000000004f4dde38da9f8abbb96c48ca520b992d4badc3d60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000071eb5397db63efcc35561b8327ebedc22d864ed0338207fa9d606ab5bafae3550b392d9a844f0172a3414d3def5be3f345973e37cf11aed13bda023c94748b81000000000000000000000000cb5cef3c54aa90e9a7ad602a258d3d360cc862b9000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003a4a973567400000000000000000000000007b780e6d4d7177bd596e7cabf2725a471e685dc00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000007b780e6d4d7177bd596e7cabf2725a471e685dc0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000104cebfe336000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000040a5a6401ffdd5484fead495e77dee9e190a2ae486a1a5d997bdc825b8759561e35a8eb505662567c9f62fe2fc4ed153c83ae767258121251d97455866f8519d640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000411366c3d814146dd091efa814650174a09da0a9976f7ebe74948a625f0bf28d940a626baa24ca4b595bde979112e6470e0499231b9b3952a2886e2bdcf934f3b61c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004e08010801080108010801080108010801080108010801080108010801080108010" as const,
    message: `RISE Telegram Bot Verification

I am linking my wallet to Telegram account @testuser (ID: 123456789)

Timestamp: ${Date.now()}
Nonce: testNonce123

This signature proves I control this wallet and authorize the RISE bot to execute transactions on my behalf.`,
    telegramId: "123456789",
    telegramHandle: "testuser"
  };

  console.log("Test data:");
  console.log("- Address:", testData.address);
  console.log("- Signature length:", testData.signature.length, "characters");
  console.log("- Message length:", testData.message.length, "characters");
  console.log("- Telegram ID:", testData.telegramId);
  console.log("- Telegram Handle:", testData.telegramHandle);
  console.log();

  console.log("Calling verifyAndLinkAccount...");
  const result = await verifyAndLinkAccount(testData);
  
  console.log("\nüìä Verification Result:");
  console.log("Success:", result.success);
  if (result.error) {
    console.log("Error:", result.error);
  }
  
  if (result.success) {
    console.log("‚úÖ Smart wallet signature verification successful!");
    console.log("The verification flow now properly handles RISE wallet signatures.");
  } else {
    console.log("‚ùå Verification failed.");
    console.log("This could be due to:");
    console.log("1. Network connectivity issues");
    console.log("2. Smart contract not being ERC-1271 compatible");
    console.log("3. Signature format mismatch");
    console.log("4. Message content mismatch");
  }
}

testSmartWalletVerification().catch(console.error);