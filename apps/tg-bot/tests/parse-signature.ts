import "dotenv/config";
import { decodeAbiParameters, parseAbiParameters } from "viem";

// Parse the RISE wallet signature to understand its format
async function parseSignature() {
  console.log("üîç Parsing RISE Wallet Signature");
  console.log("===============================\n");

  // The actual signature from the logs
  const signature = "0x000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000001700000000000000000000000000000000000000000000000000000000000000010687e32d4db23d49f49c4efa820c7671957b81cd368b7b1ae7dffc0ff8ea1a997a6a39142d1e4d57aa75cbd7a2b698b67162c77a7cc51c4c3caecda1fcb8924600000000000000000000000000000000000000000000000000000000000000257db01d36896b5474aea489efbe45b1ff1da82a4ce0373c50b3d3cdb6d29510b41d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bb7b2274797065223a22776562617574686e2e676574222c226368616c6c656e6765223a22717470546b35723936596b346e556535457161634738375450756b727266754f75537432396c5f556e654d222c226f726967696e223a2268747470733a2f2f726973652d77616c6c65742d746573746e65742e76657263656c2e617070222c2263726f73734f726967696e223a747275652c22746f704f726967696e223a2268747470733a2f2f6c6f63616c686f73743a33303030227d00000000002ff885fbf40abacad6e1fdb7ae2654ac6cf00b1a82f431a11513ae458238e978000000000000000000000000000000000000000000000000000000000000aa39db0000000000000000000000004f4dde38da9f8abbb96c48ca520b992d4badc3d60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000071eb5397db63efcc35561b8327ebedc22d864ed0338207fa9d606ab5bafae3550b392d9a844f0172a3414d3def5be3f345973e37cf11aed13bda023c94748b81000000000000000000000000cb5cef3c54aa90e9a7ad602a258d3d360cc862b9000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000003a4a973567400000000000000000000000007b780e6d4d7177bd596e7cabf2725a471e685dc00000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000007b780e6d4d7177bd596e7cabf2725a471e685dc0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000104cebfe336000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000040a5a6401ffdd5484fead495e77dee9e190a2ae486a1a5d997bdc825b8759561e35a8eb505662567c9f62fe2fc4ed153c83ae767258121251d97455866f8519d640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000411366c3d814146dd091efa814650174a09da0a9976f7ebe74948a625f0bf28d940a626baa24ca4b595bde979112e6470e0499231b9b3952a2886e2bdcf934f3b61c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004e08010801080108010801080108010801080108010801080108010801080108010";

  console.log("Signature length:", signature.length, "characters");
  console.log("First 100 chars:", signature.substring(0, 100));
  console.log("Last 100 chars:", signature.substring(signature.length - 100));
  
  // This looks like it might be ABI encoded data
  // Let's try to decode it as different formats
  
  console.log("\n=== Attempting to Parse as ABI Encoded Data ===");
  
  try {
    // Try decoding as a tuple with bytes
    const decoded1 = decodeAbiParameters(
      parseAbiParameters("bytes"),
      signature as `0x${string}`
    );
    console.log("Decoded as bytes:", decoded1);
  } catch (e) {
    console.log("Failed to decode as bytes:", e.message);
  }
  
  try {
    // Try decoding as packed signature format from Porto
    const decoded2 = decodeAbiParameters(
      parseAbiParameters("bytes, bytes32, bool"),
      signature as `0x${string}`
    );
    console.log("Decoded as (bytes, bytes32, bool):", decoded2);
  } catch (e) {
    console.log("Failed to decode as Porto format:", e.message);
  }
  
  // Let's look for patterns in the data
  console.log("\n=== Looking for Patterns ===");
  
  // Check for JSON data (common in WebAuthn)
  const hexString = signature.slice(2); // Remove 0x
  let jsonFound = false;
  
  for (let i = 0; i < hexString.length - 40; i += 2) {
    const chunk = hexString.substr(i, 40);
    try {
      const bytes = Buffer.from(chunk, 'hex');
      const str = bytes.toString('utf8');
      if (str.includes('{') || str.includes('type') || str.includes('challenge')) {
        console.log(`Found potential JSON at position ${i}:`, str);
        jsonFound = true;
      }
    } catch (e) {
      // Ignore conversion errors
    }
  }
  
  // Try to find the WebAuthn JSON that we can see in the middle
  const webauthnPattern = /7b2274797065223a22776562617574686e/; // {"type":"webauthn in hex
  const match = signature.match(webauthnPattern);
  if (match) {
    console.log("\nFound WebAuthn pattern at index:", match.index);
    
    // Extract and decode the WebAuthn JSON
    const startIndex = match.index!;
    // Look for the end of the JSON (closing brace + padding)
    let endIndex = startIndex;
    const hex = signature.slice(2);
    
    // Find the end of the JSON by looking for }
    for (let i = startIndex; i < hex.length - 2; i += 2) {
      const char = String.fromCharCode(parseInt(hex.substr(i, 2), 16));
      if (char === '}') {
        endIndex = i + 2;
        break;
      }
    }
    
    const jsonHex = hex.slice(startIndex, endIndex);
    const jsonStr = Buffer.from(jsonHex, 'hex').toString('utf8');
    console.log("WebAuthn JSON:", jsonStr);
    
    try {
      const webauthnData = JSON.parse(jsonStr);
      console.log("Parsed WebAuthn data:", webauthnData);
    } catch (e) {
      console.log("Failed to parse WebAuthn JSON:", e.message);
    }
  }
  
  console.log("\n=== Analysis Complete ===");
  console.log("This appears to be a complex smart wallet signature containing:");
  console.log("1. ABI-encoded structure");
  console.log("2. WebAuthn authentication data");
  console.log("3. Multiple components for smart wallet verification");
  console.log("\nTo verify this signature, we need to:");
  console.log("1. Use ERC-1271 isValidSignature on the smart wallet contract");
  console.log("2. Or implement Porto's signature parsing logic");
}

parseSignature().catch(console.error);